<#
.SYNOPSIS
    gitit2
#>
$workingDir = (Get-Location).ProviderPath; [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; $gitDir = Join-Path $workingDir '.git'; if (-not (Test-Path -LiteralPath $gitDir)) { git init -b main > $null 2>&1; git config core.filemode false > $null 2>&1 }; Remove-Item -Path .git\index.lock,.git\HEAD.lock -Force -ErrorAction SilentlyContinue; git config --global user.name "Michaelunkai" > $null 2>&1; git config --global user.email "Michaelunkai@users.noreply.github.com" > $null 2>&1; git config --global --add safe.directory $workingDir > $null 2>&1; git config --global init.defaultBranch main > $null 2>&1; git config --global core.autocrlf false > $null 2>&1; $username = "Michaelunkai"; $repoName = Split-Path -Leaf $workingDir; $repoName = ($repoName -replace "\s+", "-").ToLowerInvariant(); $repoName = $repoName -replace "[^a-z0-9-]", ""; $hasFiles = $true; try { $enum = [System.IO.Directory]::EnumerateFiles($workingDir,"*",[System.IO.SearchOption]::AllDirectories).GetEnumerator(); if (-not $enum.MoveNext()) { $hasFiles = $false } } catch { $hasFiles = $true }; if ($hasFiles) { $addOk = $false; git add -A > $null 2>&1; if ($LASTEXITCODE -eq 0) { $addOk = $true }; if (-not $addOk) { git add . > $null 2>&1; if ($LASTEXITCODE -eq 0) { $addOk = $true } }; if (-not $addOk) { $items = @(Get-ChildItem -Path . -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Name); if ($items.Count -gt 0) { git add -- $items > $null 2>&1; if ($LASTEXITCODE -eq 0) { $addOk = $true } } }; if (-not $addOk) { Write-Host "All git add methods failed, creating empty commit"; git commit --allow-empty -m ("Empty repo init {0}" -f (Get-Date -Format "yyyy-MM-dd HH:mm:ss")) > $null 2>&1 } else { git status > $null 2>&1; if ($LASTEXITCODE -eq 0) { git diff --cached --quiet > $null 2>&1; if ($LASTEXITCODE -eq 1) { git commit -m ("Auto commit {0} - batch update" -f (Get-Date -Format "yyyy-MM-dd HH:mm:ss")) > $null 2>&1 } elseif ($LASTEXITCODE -ne 0) { Write-Host "git diff --cached failed" } } } } else { git commit --allow-empty -m ("Empty directory init {0}" -f (Get-Date -Format "yyyy-MM-dd HH:mm:ss")) > $null 2>&1 }; $remoteUrl = ("https://github.com/{0}/{1}.git" -f $username,$repoName); git remote remove origin > $null 2>&1; git remote add origin $remoteUrl > $null 2>&1; git branch -M main > $null 2>&1; $repoApiUrl = ("https://api.github.com/repos/{0}/{1}" -f $username,$repoName); $repoExists = $false; try { $resp = Invoke-WebRequest -Uri $repoApiUrl -Method Head -UseBasicParsing -ErrorAction Stop; if ($resp.StatusCode -eq 200) { $repoExists = $true } } catch { }; $ghAvailable = $false; try { Get-Command gh -ErrorAction Stop | Out-Null; $ghAvailable = $true } catch { }; $ghAuthenticated = $false; if ($ghAvailable) { gh auth status > $null 2>&1; if ($LASTEXITCODE -eq 0) { $ghAuthenticated = $true } }; $token = $null; if ($env:GITHUB_TOKEN) { $token = $env:GITHUB_TOKEN } elseif ($env:GH_TOKEN) { $token = $env:GH_TOKEN } elseif ($env:GIT_PAT) { $token = $env:GIT_PAT }; if ($ghAvailable -and -not $ghAuthenticated -and $token) { $token | gh auth login --hostname github.com --with-token > $null 2>&1; if ($LASTEXITCODE -eq 0) { $ghAuthenticated = $true } }; if (-not $repoExists -and $ghAvailable -and $ghAuthenticated) { gh repo view ("{0}/{1}" -f $username,$repoName) > $null 2>&1; if ($LASTEXITCODE -ne 0) { gh repo create ("{0}/{1}" -f $username,$repoName) --public > $null 2>&1; if ($LASTEXITCODE -eq 0) { Start-Sleep -Seconds 2; $repoExists = $true } } else { $repoExists = $true } }; if (-not $repoExists -and $token) { $headers = @{ Authorization = "token $token"; "User-Agent" = "mcp-auto-init"; Accept = "application/vnd.github+json"; "Content-Type" = "application/json" }; $body = @{ name = $repoName; "private" = $false } | ConvertTo-Json; try { Invoke-RestMethod -Method Post -Uri "https://api.github.com/user/repos" -Headers $headers -Body $body -ErrorAction Stop | Out-Null; Start-Sleep -Seconds 2; $repoExists = $true } catch { } }; if (-not $repoExists -and -not $token -and -not ($ghAvailable -and $ghAuthenticated)) { Write-Host "[WARN] GitHub auth missing. Run 'gh auth login' or set GITHUB_TOKEN / GH_TOKEN / GIT_PAT before rerunning." }; $pushOk = $false; if ($repoExists) { git push --set-upstream origin main --force > $null 2>&1; if ($LASTEXITCODE -eq 0) { $pushOk = $true } elseif ($ghAvailable) { Start-Sleep -Seconds 3; git push --set-upstream origin main --force > $null 2>&1; if ($LASTEXITCODE -eq 0) { $pushOk = $true } } } else { Write-Host ("Remote repo {0}/{1} not created; skipping push" -f $username,$repoName) }; if (-not $pushOk -and $repoExists) { Write-Host "Push failed, but repo processed" }; Remove-Item -Path .git\*.lock -Force -ErrorAction SilentlyContinue; try { if (Get-Command rmgit -ErrorAction Stop) { rmgit > $null 2>&1 } } catch { }; Write-Host ("[OK] Processed: {0}" -f $workingDir)
